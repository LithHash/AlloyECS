"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[488],{8216:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>d,toc:()=>s});const d=JSON.parse('{"id":"guides/deferred-operations","title":"Deferred Operations","description":"Deferred operations let you safely queue changes during iteration. This is essential when you need to modify entities while looping through query results.","source":"@site/docs/guides/deferred-operations.md","sourceDirName":"guides","slug":"/guides/deferred-operations","permalink":"/AlloyECS/docs/guides/deferred-operations","draft":false,"unlisted":false,"editUrl":"https://github.com/LithHash/AlloyECS/edit/main/docs/guides/deferred-operations.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"defaultSidebar","previous":{"title":"Prefabs","permalink":"/AlloyECS/docs/guides/prefabs"}}');var t=r(4848),l=r(8453);const i={sidebar_position:6},o="Deferred Operations",a={},s=[{value:"The Problem",id:"the-problem",level:2},{value:"The Solution",id:"the-solution",level:2},{value:"Deferred Methods",id:"deferred-methods",level:2},{value:"Examples",id:"examples",level:2},{value:"Deferred Spawn",id:"deferred-spawn",level:3},{value:"Deferred Destroy",id:"deferred-destroy",level:3},{value:"Deferred Component Changes",id:"deferred-component-changes",level:3},{value:"Chaining",id:"chaining",level:2},{value:"Checking Pending Commands",id:"checking-pending-commands",level:2},{value:"Deferred Mode",id:"deferred-mode",level:2},{value:"Automatic Flushing",id:"automatic-flushing",level:2},{value:"Practical Example",id:"practical-example",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"1. Prefer Deferred During Iteration",id:"1-prefer-deferred-during-iteration",level:3},{value:"2. Batch Related Operations",id:"2-batch-related-operations",level:3},{value:"3. Let step() Handle Flushing",id:"3-let-step-handle-flushing",level:3}];function h(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,l.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"deferred-operations",children:"Deferred Operations"})}),"\n",(0,t.jsx)(n.p,{children:"Deferred operations let you safely queue changes during iteration. This is essential when you need to modify entities while looping through query results."}),"\n",(0,t.jsx)(n.h2,{id:"the-problem",children:"The Problem"}),"\n",(0,t.jsx)(n.p,{children:"Modifying entities during iteration can cause issues:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"-- \u274c Dangerous - modifying during iteration\r\nfor entityId, health in world:query(Health) do\r\n    if health <= 0 then\r\n        world:destroy(entityId)  -- Might break iteration!\r\n    end\r\nend\n"})}),"\n",(0,t.jsx)(n.h2,{id:"the-solution",children:"The Solution"}),"\n",(0,t.jsx)(n.p,{children:"Queue operations and execute them after iteration:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"-- \u2705 Safe - deferred operations\r\nfor entityId, health in world:query(Health) do\r\n    if health <= 0 then\r\n        world:deferDestroy(entityId)\r\n    end\r\nend\r\nworld:flush()  -- Execute all queued operations\n"})}),"\n",(0,t.jsx)(n.h2,{id:"deferred-methods",children:"Deferred Methods"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Method"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"deferSpawn(callback?)"})}),(0,t.jsx)(n.td,{children:"Queue entity creation"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"deferDestroy(entityId)"})}),(0,t.jsx)(n.td,{children:"Queue entity destruction"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"deferAdd(entityId, componentId)"})}),(0,t.jsx)(n.td,{children:"Queue adding a tag"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"deferSet(entityId, componentId, value)"})}),(0,t.jsx)(n.td,{children:"Queue setting a component"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"deferRemove(entityId, componentId)"})}),(0,t.jsx)(n.td,{children:"Queue removing a component"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"flush()"})}),(0,t.jsx)(n.td,{children:"Execute all queued operations"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,t.jsx)(n.h3,{id:"deferred-spawn",children:"Deferred Spawn"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"-- Spawn with callback to configure the new entity\r\nworld:deferSpawn(function(entityId)\r\n    world:deferSet(entityId, Position, Vector3.zero)\r\n    world:deferSet(entityId, Health, 100)\r\n    world:deferAdd(entityId, Enemy)\r\nend)\r\nworld:flush()\n"})}),"\n",(0,t.jsx)(n.h3,{id:"deferred-destroy",children:"Deferred Destroy"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"for entityId, health in world:query(Health) do\r\n    if health <= 0 then\r\n        world:deferDestroy(entityId)\r\n    end\r\nend\r\nworld:flush()\n"})}),"\n",(0,t.jsx)(n.h3,{id:"deferred-component-changes",children:"Deferred Component Changes"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"for entityId, pos, vel in world:query(Position, Velocity) do\r\n    -- Queue position update\r\n    world:deferSet(entityId, Position, pos + vel * deltaTime)\r\n    \r\n    -- Queue removing velocity if stopped\r\n    if vel.Magnitude < 0.1 then\r\n        world:deferRemove(entityId, Velocity)\r\n    end\r\nend\r\nworld:flush()\n"})}),"\n",(0,t.jsx)(n.h2,{id:"chaining",children:"Chaining"}),"\n",(0,t.jsx)(n.p,{children:"Deferred methods return the world for chaining:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"world\r\n    :deferSpawn(function(e)\r\n        world:deferSet(e, Position, Vector3.zero)\r\n    end)\r\n    :deferDestroy(oldEntity)\r\n    :deferSet(player, Health, 100)\r\n\r\nworld:flush()\n"})}),"\n",(0,t.jsx)(n.h2,{id:"checking-pending-commands",children:"Checking Pending Commands"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"if world:hasPendingCommands() then\r\n    world:flush()\r\nend\n"})}),"\n",(0,t.jsx)(n.h2,{id:"deferred-mode",children:"Deferred Mode"}),"\n",(0,t.jsx)(n.p,{children:"Enable deferred mode to use regular methods that auto-queue:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"world:defer()  -- Enable deferred mode\r\n\r\n-- These are now automatically queued\r\nworld:set(entity, Health, 50)\r\nworld:add(entity, Poisoned)\r\n\r\nworld:flush()  -- Execute and disable deferred mode\n"})}),"\n",(0,t.jsx)(n.h2,{id:"automatic-flushing",children:"Automatic Flushing"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"world:step()"})," automatically flushes pending commands:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"RunService.Heartbeat:Connect(function(dt)\r\n    -- Systems can use deferred operations freely\r\n    world:step(dt)  -- Flushes at the start\r\nend)\n"})}),"\n",(0,t.jsx)(n.h2,{id:"practical-example",children:"Practical Example"}),"\n",(0,t.jsx)(n.p,{children:"A damage system that safely handles death:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:'local Health = world:component()\r\nlocal Damage = world:component()\r\nlocal Dead = world:tag()\r\n\r\nworld:addSystem("ApplyDamage", "Update", {\r\n    reads = { Damage, Health },\r\n    writes = { Health, Dead }\r\n}, function(dt)\r\n    -- Process damage\r\n    for entityId, damage, health in world:query(Damage, Health) do\r\n        local newHealth = health - damage\r\n        world:deferSet(entityId, Health, newHealth)\r\n        world:deferRemove(entityId, Damage)\r\n        \r\n        if newHealth <= 0 then\r\n            world:deferAdd(entityId, Dead)\r\n        end\r\n    end\r\n    -- Note: flush happens automatically in step()\r\nend)\r\n\r\nworld:addSystem("Cleanup", "PostUpdate", {\r\n    reads = { Dead }\r\n}, function(dt)\r\n    for entityId in world:query(Dead) do\r\n        world:deferDestroy(entityId)\r\n    end\r\nend)\n'})}),"\n",(0,t.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,t.jsx)(n.h3,{id:"1-prefer-deferred-during-iteration",children:"1. Prefer Deferred During Iteration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"-- \u2705 Good\r\nfor entityId, health in world:query(Health) do\r\n    if health <= 0 then\r\n        world:deferDestroy(entityId)\r\n    end\r\nend\r\n\r\n-- \u274c Risky\r\nfor entityId, health in world:query(Health) do\r\n    if health <= 0 then\r\n        world:destroy(entityId)\r\n    end\r\nend\n"})}),"\n",(0,t.jsx)(n.h3,{id:"2-batch-related-operations",children:"2. Batch Related Operations"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"-- \u2705 Good - one flush for multiple operations\r\nfor entityId in world:query(Enemy) do\r\n    world:deferSet(entityId, Health, 100)\r\n    world:deferRemove(entityId, Damaged)\r\nend\r\nworld:flush()\r\n\r\n-- \u274c Inefficient - flush after each\r\nfor entityId in world:query(Enemy) do\r\n    world:deferSet(entityId, Health, 100)\r\n    world:flush()  -- Don't do this!\r\nend\n"})}),"\n",(0,t.jsx)(n.h3,{id:"3-let-step-handle-flushing",children:"3. Let step() Handle Flushing"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:'-- \u2705 Good - step handles it\r\nworld:addSystem("MySystem", "Update", {}, function(dt)\r\n    world:deferSet(entity, Health, 100)\r\n    -- No need to flush - step() does it\r\nend)\r\n\r\n-- Works because step() flushes automatically\r\nRunService.Heartbeat:Connect(function(dt)\r\n    world:step(dt)\r\nend)\n'})})]})}function c(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>o});var d=r(6540);const t={},l=d.createContext(t);function i(e){const n=d.useContext(l);return d.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),d.createElement(l.Provider,{value:n},e.children)}}}]);